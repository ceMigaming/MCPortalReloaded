package com.cemi.portalreloaded.packets;

import java.util.ArrayList;

import io.netty.buffer.ByteBuf;
import me.ichun.mods.ichunutil.common.iChunUtil;
import me.ichun.mods.ichunutil.common.core.network.AbstractPacket;
import me.ichun.mods.ichunutil.common.grab.GrabHandler;
import me.ichun.mods.ichunutil.common.item.ItemHandler;
import me.ichun.mods.portalgun.common.PortalGun;
import me.ichun.mods.portalgun.common.portal.PortalGunGrabHandler;
import net.minecraft.client.Minecraft;
import net.minecraft.entity.EntityLivingBase;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.item.ItemStack;
import net.minecraftforge.fml.common.network.ByteBufUtils;
import net.minecraftforge.fml.relauncher.Side;
import net.minecraftforge.fml.relauncher.SideOnly;

public class MessageGrabEvent extends AbstractPacket {
    public String ident;
    public int grabberId;
    public int grabbedId;
    public float dist;
    public boolean grabbed;
    
    public MessageGrabEvent() {
    }
    
    public MessageGrabEvent(String string, int integer3, int integer4, float float5, boolean boolean6) {
        this.ident = string;
        this.grabberId = integer3;
        this.grabbedId = integer4;
        this.dist = float5;
        this.grabbed = boolean6;
    }
    
    public void writeTo(ByteBuf byteBuf) {
        ByteBufUtils.writeUTF8String(byteBuf, this.ident);
        byteBuf.writeInt(this.grabberId);
        byteBuf.writeInt(this.grabbedId);
        byteBuf.writeFloat(this.dist);
        byteBuf.writeBoolean(this.grabbed);
    }
    
    public void readFrom(ByteBuf byteBuf) {
        this.ident = ByteBufUtils.readUTF8String(byteBuf);
        this.grabberId = byteBuf.readInt();
        this.grabbedId = byteBuf.readInt();
        this.dist = byteBuf.readFloat();
        this.grabbed = byteBuf.readBoolean();
    }
    
    public void execute(Side side, EntityPlayer entityPlayer) {
    	System.out.println(GrabHandler.grabbedEntities);
        this.handleClient();
    }
    
    public Side receivingSide() {
        return Side.CLIENT;
    }
    
    @SideOnly(Side.CLIENT)
    public void handleClient() {
        ArrayList<GrabHandler> arrayList2 = GrabHandler.grabbedEntities.get(Side.CLIENT);
        ArrayList<PortalGunGrabHandler> arrayList3 = new ArrayList<PortalGunGrabHandler>();
        for (final GrabHandler handler : GrabHandler.grabbedEntities.get(Side.CLIENT)) {
            if (handler instanceof PortalGunGrabHandler) {
                arrayList3.add((PortalGunGrabHandler)handler);
            }
        }
        if (this.grabbed) {
            boolean boolean4 = false;
            for (final PortalGunGrabHandler handler2 : arrayList3) {
                if (handler2.identifier.equals(this.ident)) {
                    boolean4 = true;
                    if (handler2.grabberId != this.grabberId || handler2.grabbedId != this.grabbedId) {
                        handler2.grabber = null;
                        handler2.grabbed = null;
                        handler2.grabberId = this.grabberId;
                        handler2.grabbedId = this.grabbedId;
                        handler2.getIDs();
                    }
                    handler2.grabDistance = this.dist;
                    break;
                }
            }
            if (!boolean4) {
                PortalGunGrabHandler portalGunGrabHandler5 = new PortalGunGrabHandler(this.ident, this.grabberId, this.grabbedId, this.dist);
                arrayList2.add(portalGunGrabHandler5);
                portalGunGrabHandler5.getIDs();
                ItemStack itemStack6 = ItemHandler.getUsableDualHandedItem((EntityLivingBase)Minecraft.getMinecraft().player);
                if (this.grabberId == Minecraft.getMinecraft().player.getEntityId()) {
                    iChunUtil.proxy.nudgeHand(15.0f);
                }
            }
        }
        else {
            for (final PortalGunGrabHandler handler3 : arrayList3) {
                if (handler3.identifier.equals(this.ident)) {
                    arrayList2.remove(handler3);
                    handler3.terminate();
                    ItemStack itemStack6 = ItemHandler.getUsableDualHandedItem((EntityLivingBase)Minecraft.getMinecraft().player);
                    if (this.grabberId == Minecraft.getMinecraft().player.getEntityId()) {
                        iChunUtil.proxy.nudgeHand(15.0f);
                        break;
                    }
                    break;
                }
            }
        }
    }
}
